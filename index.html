<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ÙƒØªØ§Ù„ÙˆØ¬ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
  <style>
    body{font-family:system-ui,Segoe UI,Tahoma,Arial; margin:0; background:#0f1115; color:#fff}
    header{padding:16px; position:sticky; top:0; background:#0f1115cc; backdrop-filter: blur(10px); border-bottom:1px solid #222; z-index:10}
    .wrap{max-width:1100px; margin:auto; padding:16px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    input,select,textarea{padding:10px; border-radius:12px; border:1px solid #2a2a2a; background:#151922; color:#fff; outline:none}
    button{padding:10px 12px; border-radius:12px; border:0; cursor:pointer}
    .btn{background:#2d7dff; color:#fff; font-weight:700}
    .btn2{background:#23283a; color:#fff}
    .grid{display:grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap:14px}
    .card{background:#151922; border:1px solid #23283a; border-radius:18px; overflow:hidden; position:relative}
    .card img{width:100%; height:175px; object-fit:cover; display:block; background:#0b0d12}
    .p{padding:12px}
    .muted{opacity:.75; font-size:13px}
    .priceLine{display:flex; gap:10px; align-items:baseline; flex-wrap:wrap}
    .price{font-size:16px; font-weight:900}
    .old{opacity:.65; text-decoration:line-through}
    .badge{position:absolute; top:10px; right:10px; background:#ff3b3b; padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px}
    .badge2{position:absolute; top:10px; left:10px; background:#2d7dff; padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px}
    .cartbar{position:fixed; bottom:16px; left:16px; right:16px; max-width:1100px; margin:auto; background:#151922; border:1px solid #23283a; border-radius:18px; padding:12px; display:flex; gap:10px; align-items:center; justify-content:space-between}
    .pill{background:#2d7dff; padding:4px 10px; border-radius:999px; font-weight:900}
    .modal{position:fixed; inset:0; background:#0008; display:none; align-items:center; justify-content:center; padding:16px; z-index:20}
    .box{max-width:760px; width:100%; background:#0f1115; border:1px solid #23283a; border-radius:18px; padding:14px}
    table{width:100%; border-collapse:collapse}
    td,th{border-bottom:1px solid #23283a; padding:10px; text-align:right; vertical-align:top}
    .smallbtn{padding:6px 10px; border-radius:10px}
    .totals{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    .totalCard{background:#151922; border:1px solid #23283a; border-radius:16px; padding:12px}
  </style>
</head>
<body>
<header>
  <div class="wrap row" style="align-items:center; justify-content:space-between">
    <div style="font-weight:900; font-size:18px">ğŸ›ï¸ ÙƒØªØ§Ù„ÙˆØ¬ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
    <div class="row" style="align-items:center">
      <input id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." />
      <select id="cat"><option value="">ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option></select>
      <button class="btn2" onclick="openCart()">Ø§Ù„Ø³Ù„Ø© ğŸ›’</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="status" class="muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</div>
  <div id="grid" class="grid" style="margin-top:12px"></div>
</main>

<div class="cartbar">
  <div class="row" style="align-items:center">
    <div>Ø§Ù„Ø³Ù„Ø©</div>
    <div class="pill" id="cartCount">0</div>
    <div class="muted" id="cartTotal">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0</div>
  </div>
  <div class="row">
    <button class="btn2" onclick="clearCart()">ØªÙØ±ÙŠØº</button>
    <button class="btn" onclick="openCart()">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>
  </div>
</div>

<div class="modal" id="modal">
  <div class="box">
    <div class="row" style="justify-content:space-between; align-items:center">
      <div style="font-weight:900">ğŸ§¾ Ø§Ù„Ø³Ù„Ø© ÙˆØ¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</div>
      <button class="btn2" onclick="closeCart()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:10px">
      <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†" />
      <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" />
      <input id="address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„ + Ø£Ù‚Ø±Ø¨ Ù†Ù‚Ø·Ø© Ø¯Ù„Ø§Ù„Ø©" style="grid-column:1 / -1" />
      <textarea id="note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" rows="3" style="grid-column:1 / -1"></textarea>
    </div>

    <div style="margin-top:12px; overflow:auto; max-height:300px">
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¹Ø¯Ø¯</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th></th>
          </tr>
        </thead>
        <tbody id="cartRows"></tbody>
      </table>
    </div>

    <div class="totals">
      <div class="totalCard">
        <div class="muted">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…</div>
        <div style="font-weight:900; font-size:18px" id="sumOld">0</div>
      </div>
      <div class="totalCard">
        <div class="muted">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…</div>
        <div style="font-weight:900; font-size:18px" id="sumNew">0</div>
      </div>
      <div class="totalCard" style="grid-column:1 / -1">
        <div class="muted">Ù…Ù‚Ø¯Ø§Ø± Ø§Ù„ØªÙˆÙÙŠØ±</div>
        <div style="font-weight:900; font-size:18px" id="sumSave">0</div>
      </div>
    </div>

    <div class="row" style="justify-content:space-between; margin-top:12px; align-items:center">
      <div class="muted">Ø³ÙŠØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø±Ø³Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²Ø© ØªØªØ¶Ù…Ù† ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙƒØ§Ù…Ù„Ø©.</div>
      <button class="btn" onclick="sendWhatsApp()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨</button>
    </div>
  </div>
</div>

<script>
  // âœ… Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ø¨Ø¯ÙˆÙ† +)
  const WHATSAPP_NUMBER = "9647719183122";

  // âœ… Ø±Ø§Ø¨Ø· CSV Ù…Ù† Google Sheet
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRlOmNYb8nqPMu2NXgFxXop7R5qmqeoPw3EhHzH8ghHmNLdnd8YxwrnL9tQdVxs4EYKM3X2KRWkICcf/pub?gid=0&single=true&output=csv";

  const $ = (id)=>document.getElementById(id);
  const state = { products:[], cart: loadCart() };

  function loadCart(){ try{ return JSON.parse(localStorage.getItem("cart")||"{}"); }catch(e){ return {}; } }
  function saveCart(){ localStorage.setItem("cart", JSON.stringify(state.cart)); renderCartBar(); }

  function splitCSVLine(line){
    const out=[]; let cur=""; let inQ=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c === '"'){ inQ = !inQ; continue; }
      if(c === ',' && !inQ){ out.push(cur); cur=""; continue; }
      cur += c;
    }
    out.push(cur);
    return out;
  }
  function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    const headers = splitCSVLine(lines[0]).map(h=>h.trim());
    return lines.slice(1).map(line=>{
      const cols = splitCSVLine(line);
      const obj = {};
      headers.forEach((h,i)=>obj[h]= (cols[i]||"").trim());
      return obj;
    });
  }

  function money(n){ return (Number(n)||0).toLocaleString("ar-IQ"); }
  function esc(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
  function pct(oldP, newP){
    oldP = Number(oldP||0); newP = Number(newP||0);
    if(!oldP || oldP <= newP) return 0;
    return Math.round(((oldP - newP) / oldP) * 100);
  }

  async function loadProducts(){
    try{
      const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
      const text = await res.text();
      const rows = parseCSV(text);

      state.products = rows
        .filter(r=>r.id && r.name)
        .map(r=>{
          const price = Number(r.price||0);
          const old_price = Number(r.old_price||0) || price;
          const offer = String(r.offer||"").toLowerCase().trim() === "yes";
          const disc = pct(old_price, price);
          return {
            id: String(r.id),
            name: r.name,
            price,
            old_price,
            offer,
            discount_note: r.discount_note || "",
            image: r.image || "",
            category: r.category || "Ø¹Ø§Ù…",
            desc: r.desc || "",
            discountPercent: disc
          };
        });

      $("status").textContent = `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${state.products.length} Ù…Ù†ØªØ¬`;
      buildCategories();
      renderProducts();
      renderCartBar();
    }catch(e){
      $("status").textContent = "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ø§Ø¨Ø· CSV ÙˆÙ…Ù† Ø£Ù†Ù‡ Published.";
      console.error(e);
    }
  }

  function buildCategories(){
    const cats = [...new Set(state.products.map(p=>p.category))].sort();
    const sel = $("cat");
    cats.forEach(c=>{
      const o=document.createElement("option");
      o.value=c; o.textContent=c;
      sel.appendChild(o);
    });
  }

  function renderProducts(){
    const q = ($("q").value||"").toLowerCase();
    const cat = $("cat").value;

    const list = state.products.filter(p=>{
      const okQ = !q || (p.name.toLowerCase().includes(q) || p.desc.toLowerCase().includes(q));
      const okC = !cat || p.category === cat;
      return okQ && okC;
    });

    const grid = $("grid");
    grid.innerHTML = "";
    list.forEach(p=>{
      const card = document.createElement("div");
      card.className = "card";

      const showDiscount = p.old_price > p.price;
      const badgeDiscount = showDiscount ? `Ø®ØµÙ… ${p.discountPercent}%` : "";
      const badgeOffer = p.offer ? (p.discount_note ? p.discount_note : "Ø¹Ø±Ø¶ Ø®Ø§Øµ") : "";

      card.innerHTML = `
        ${showDiscount ? `<div class="badge">${esc(badgeDiscount)}</div>` : ``}
        ${p.offer ? `<div class="badge2">${esc(badgeOffer)}</div>` : ``}
        <img src="${esc(p.image)}" onerror="this.style.display='none'">
        <div class="p">
          <div style="font-weight:900">${esc(p.name)}</div>
          <div class="muted">${esc(p.category)} â€¢ ${esc(p.desc)}</div>

          <div class="priceLine" style="margin-top:8px">
            <div class="price">${money(p.price)} Ø¯.Ø¹</div>
            ${showDiscount ? `<div class="old">${money(p.old_price)} Ø¯.Ø¹</div>` : ``}
          </div>

          <div class="row" style="justify-content:space-between; align-items:center; margin-top:10px">
            <button class="btn" onclick="addToCart('${p.id}')">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
            <button class="btn2" onclick="buyNow('${p.id}')">Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</button>
          </div>
        </div>
      `;
      grid.appendChild(card);
    });
  }

  function addToCart(id){
    state.cart[id] = (state.cart[id]||0) + 1;
    saveCart();
  }
  function buyNow(id){
    addToCart(id);
    openCart();
  }
  function decFromCart(id){
    if(!state.cart[id]) return;
    state.cart[id]--;
    if(state.cart[id]<=0) delete state.cart[id];
    saveCart(); renderCartModal();
  }
  function incToCart(id){
    state.cart[id] = (state.cart[id]||0) + 1;
    saveCart(); renderCartModal();
  }
  function removeFromCart(id){
    delete state.cart[id];
    saveCart(); renderCartModal();
  }
  function clearCart(){
    state.cart = {};
    saveCart(); renderCartModal();
  }

  function cartItems(){
    return Object.entries(state.cart).map(([id,qty])=>{
      const p = state.products.find(x=>x.id===id);
      if(!p) return null;
      const lineNew = p.price * qty;
      const lineOld = p.old_price * qty;
      return { ...p, qty, lineNew, lineOld };
    }).filter(Boolean);
  }

  function renderCartBar(){
    const items = cartItems();
    const count = items.reduce((a,b)=>a+b.qty,0);
    const totalNew = items.reduce((a,b)=>a+b.lineNew,0);
    $("cartCount").textContent = count;
    $("cartTotal").textContent = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${money(totalNew)} Ø¯.Ø¹`;
  }

  function openCart(){
    $("modal").style.display="flex";
    renderCartModal();
  }
  function closeCart(){
    $("modal").style.display="none";
  }

  function renderCartModal(){
    const items = cartItems();
    const tbody = $("cartRows");
    tbody.innerHTML = "";

    let sumNew = 0, sumOld = 0;

    items.forEach(it=>{
      sumNew += it.lineNew;
      sumOld += it.lineOld;

      const showOld = it.old_price > it.price;
      const priceCell = showOld
        ? `<div><b>${money(it.price)}</b> Ø¯.Ø¹</div><div class="muted" style="text-decoration:line-through">${money(it.old_price)} Ø¯.Ø¹</div>`
        : `<div><b>${money(it.price)}</b> Ø¯.Ø¹</div>`;

      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div style="font-weight:900">${esc(it.name)}</div>
          <div class="muted">${esc(it.category)}</div>
          ${it.offer ? `<div class="muted">â­ ${esc(it.discount_note || "Ø¹Ø±Ø¶ Ø®Ø§Øµ")}</div>` : ``}
        </td>
        <td>${priceCell}</td>
        <td>
          <button class="smallbtn btn2" onclick="decFromCart('${it.id}')">-</button>
          <b style="margin:0 8px">${it.qty}</b>
          <button class="smallbtn btn2" onclick="incToCart('${it.id}')">+</button>
        </td>
        <td><b>${money(it.lineNew)}</b> Ø¯.Ø¹</td>
        <td><button class="smallbtn btn2" onclick="removeFromCart('${it.id}')">Ø­Ø°Ù</button></td>
      `;
      tbody.appendChild(tr);
    });

    const save = Math.max(0, sumOld - sumNew);
    $("sumOld").textContent = `${money(sumOld)} Ø¯.Ø¹`;
    $("sumNew").textContent = `${money(sumNew)} Ø¯.Ø¹`;
    $("sumSave").textContent = `${money(save)} Ø¯.Ø¹`;
  }

  function sendWhatsApp(){
    const items = cartItems();
    if(items.length===0){ alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©"); return; }

    const name = $("name").value.trim();
    const phone = $("phone").value.trim();
    const address = $("address").value.trim();
    const note = $("note").value.trim();

    if(!name || !phone || !address){
      alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… + Ø§Ù„Ù‡Ø§ØªÙ + Ø§Ù„Ø¹Ù†ÙˆØ§Ù†");
      return;
    }

    const sumNew = items.reduce((a,b)=>a+b.lineNew,0);
    const sumOld = items.reduce((a,b)=>a+b.lineOld,0);
    const save = Math.max(0, sumOld - sumNew);

    let msg = `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ğŸ›’%0A%0A`;
    msg += `Ø§Ù„Ø§Ø³Ù…: ${encodeURIComponent(name)}%0A`;
    msg += `Ø§Ù„Ù‡Ø§ØªÙ: ${encodeURIComponent(phone)}%0A`;
    msg += `Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${encodeURIComponent(address)}%0A`;
    if(note) msg += `Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${encodeURIComponent(note)}%0A`;
    msg += `%0AØ§Ù„Ù…Ù†ØªØ¬Ø§Øª:%0A`;

    items.forEach((it,i)=>{
      const hasDisc = it.old_price > it.price;
      const line = `${i+1}) ${it.name} | Ø¹Ø¯Ø¯: ${it.qty} | Ø³Ø¹Ø±: ${it.price} | Ù…Ø¬Ù…ÙˆØ¹: ${it.lineNew}` +
        (hasDisc ? ` | Ù‚Ø¨Ù„: ${it.old_price}` : ``) +
        (it.offer ? ` | Ø¹Ø±Ø¶: ${it.discount_note || "Ø¹Ø±Ø¶ Ø®Ø§Øµ"}` : ``);
      msg += `${encodeURIComponent(line)}%0A`;
    });

    msg += `%0AØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…: ${sumOld}%0A`;
    msg += `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…: ${sumNew}%0A`;
    msg += `Ø§Ù„ØªÙˆÙÙŠØ±: ${save}%0A`;

    const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`;
    window.open(url, "_blank");
  }

  $("q").addEventListener("input", renderProducts);
  $("cat").addEventListener("change", renderProducts);

  loadProducts();
</script>
</body>
</html>
